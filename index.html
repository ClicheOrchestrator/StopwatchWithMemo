<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Offline Stopwatch</title>
    
    <!-- React CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA 相关标签 -->
    <meta name="description" content="A simple stopwatch that works offline">
    <meta name="theme-color" content="#1677ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Stopwatch">
    
    <!-- PWA 图标 -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192x192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192x192.png">
    
    <!-- PWA manifest -->
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
            transition: background-color 0.5s ease;
        }
        
        body.oled-mode {
            background-color: #000000;
            color: #ffffff;
        }
        
        #root {
            padding: 10px;
            max-width: 600px;
            margin: 0 auto;
            transition: transform 0.5s ease;
        }
        
        .oled-mode #root > * {
            position: relative;
        }
        
        @keyframes oledShift {
            0% { transform: translateX(0) translateY(0); }
            25% { transform: translateX(1px) translateY(0); }
            50% { transform: translateX(1px) translateY(1px); }
            75% { transform: translateX(0) translateY(1px); }
            100% { transform: translateX(0) translateY(0); }
        }

        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
            min-width: 100px;
            height: 50px;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-primary {
            background-color: #1677ff;
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            background-color: #4096ff;
        }

        .button-danger {
            background-color: #ff4d4f;
            color: white;
        }

        .button-danger:hover:not(:disabled) {
            background-color: #ff7875;
        }

        .button-default {
            background-color: #ffffff;
            border: 1px solid #d9d9d9;
            color: rgba(0, 0, 0, 0.88);
        }

        .button-default:hover:not(:disabled) {
            border-color: #4096ff;
            color: #4096ff;
        }
        
        .oled-mode .button-default {
            background-color: #000000;
            border: 1px solid #444444;
            color: #ffffff;
        }
        
        .oled-mode .button-default:hover:not(:disabled) {
            border-color: #4096ff;
            color: #4096ff;
        }
        
        .button-toggle {
            background-color: #ffffff;
            border: 1px solid #d9d9d9;
            color: rgba(0, 0, 0, 0.88);
        }
        
        .button-toggle.active {
            background-color: #1677ff;
            color: white;
            border-color: #1677ff;
        }
        
        .oled-mode .button-toggle {
            background-color: #000000;
            border: 1px solid #444444;
            color: #ffffff;
        }
        
        .oled-mode .button-toggle.active {
            background-color: #1677ff;
            color: white;
            border-color: #1677ff;
        }

        .input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .input:focus {
            outline: none;
            border-color: #4096ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }
        
        .oled-mode .input {
            background-color: #000000;
            border: 1px solid #444444;
            color: #ffffff;
        }
        
        .oled-mode .input:focus {
            border-color: #4096ff;
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .lap-list {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-top: 20px;
        }

        .lap-header {
            padding: 16px;
            background-color: #fafafa;
            border-bottom: 1px solid #d9d9d9;
            font-weight: bold;
        }

        .lap-item {
            padding: 16px;
            border-bottom: 1px solid #d9d9d9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .memo-box {
            background-color: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            margin-left: 20px;
            flex: 1;
        }
        
        .oled-mode .lap-list {
            border: 1px solid #444444;
            background-color: #000000;
        }
        
        .oled-mode .lap-header {
            background-color: #111111;
            border-bottom: 1px solid #444444;
            color: #ffffff;
        }
        
        .oled-mode .lap-item {
            border-bottom: 1px solid #444444;
            color: #ffffff;
        }
        
        .oled-mode .memo-box {
            background-color: #111111;
            color: #ffffff;
        }
        
        /* 设置面板样式 */
        .settings-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 1px solid #d9d9d9;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .settings-panel.active {
            transform: translateY(0);
        }
        
        .oled-mode .settings-panel {
            background-color: #000000;
            border-top: 1px solid #444444;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .settings-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .oled-mode .settings-close {
            color: #ccc;
        }
        
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        
        .oled-mode .settings-item {
            border-bottom: 1px solid #333;
        }
        
        .settings-item:last-child {
            border-bottom: none;
        }
        
        /* 开关按钮样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #1677ff;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #1677ff;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        .custom-message {
            background-color: #FFF1F0;  /* 更柔和的淡红色背景 */
            border: 1px solid #FFCCC7;  /* 淡红色边框 */
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            font-size: 16px;
            line-height: 1.5;
            color: rgba(0, 0, 0, 0.88);
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
        }

        .custom-message-input {
            width: calc(100% - 20px);
            min-height: 60px;
            padding: 10px;
            border: 1px solid #FFCCC7;  /* 匹配外框的颜色 */
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.5;
            margin: 0;
            color: rgba(0, 0, 0, 0.88);
            resize: vertical;
            background-color: #ffffff;
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
        }
        
        .oled-mode .custom-message {
            background-color: #1a0000;
            border: 1px solid #5c1e1b;
            color: #ffffff;
        }
        
        .oled-mode .custom-message-input {
            background-color: #000000;
            border: 1px solid #5c1e1b;
            color: #ffffff;
        }

        .custom-message-input:focus {
            outline: none;
            border-color: #FF7875;  /* 红色系的焦点边框 */
            box-shadow: 0 0 0 2px rgba(255, 120, 117, 0.2);  /* 红色系的焦点阴影 */
        }

                /* 添加移动端优化样式 */
                @media (max-width: 768px) {
            body {
                touch-action: manipulation;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            .button {
                min-height: 44px; /* 更适合触摸的按钮大小 */
                margin: 8px 0;
            }
            
            input {
                font-size: 16px; /* 防止 iOS 自动放大 */
            }
        }

                
        /* 添加安装提示样式 */
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #1677ff;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: none;
            z-index: 1000;
        }
        
        /* 添加全屏模式下的安全区域padding */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        /* 倒计时覆盖层闪烁动画 */
        @keyframes countdownFlash {
            0%   { background-color: rgba(255, 0, 0, 0.10); }
            50%  { background-color: rgba(255, 0, 0, 0.30); }
            100% { background-color: rgba(255, 0, 0, 0.10); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="install-prompt" class="install-prompt">
        点击添加到主屏幕以获得最佳体验
    </div>
    <script type="text/babel">
        const { useState, useRef, useEffect, useCallback } = React;

        // 秒表组件
        const Stopwatch = () => {
            // 状态管理
            const [time, setTime] = useState(0);          // 总计时时间
            const [laps, setLaps] = useState([]);         // 所有计次记录
            const [isRunning, setIsRunning] = useState(false);  // 秒表运行状态
            const [customMessage, setCustomMessage] = useState(localStorage.getItem('customMessage') || ''); // 自定义消息
            // 倒计时提醒相关状态
            const [countdownDuration, setCountdownDuration] = useState(5 * 60 * 1000); // 默认 5 分钟
            const [countdownRemaining, setCountdownRemaining] = useState(5 * 60 * 1000);
            const [isCountdownRunning, setIsCountdownRunning] = useState(false);
            const [showCountdownAlert, setShowCountdownAlert] = useState(false);
            // OLED模式相关状态
            const [isOledMode, setIsOledMode] = useState(localStorage.getItem('oledMode') === 'true');
            // 通知相关状态
            const [notificationPermission, setNotificationPermission] = useState('default');
            const [notificationsEnabled, setNotificationsEnabled] = useState(
                localStorage.getItem('notificationsEnabled') !== 'false' // 默认开启
            );
            // 设置面板状态
            const [showSettings, setShowSettings] = useState(false);

            // 引用值管理
            const intervalIdRef = useRef(null);           // 定时器ID
            const startTimeRef = useRef(0);              // 开始时间戳
            const lapStartTimeRef = useRef(0);           // 当前计次开始时间戳
            const currentTimeRef = useRef(0);            // 当前时间引用

            // 倒计时引用
            const countdownIntervalRef = useRef(null);   // 倒计时定时器 ID
            const countdownStartRef = useRef(null);      // 倒计时当前周期开始时间

            // 初始化效果：从本地存储恢复状态并请求通知权限
            useEffect(() => {
                // 恢复秒表状态
                const savedState = localStorage.getItem('stopwatchState');
                if (savedState) {
                    const { time, laps, isRunning: wasRunning, startTime, lapStartTime } = JSON.parse(savedState);
                    const now = Date.now();
                    
                    let adjustedLaps = [...laps];
                    const lastLapStartTime = lapStartTime;
                    
                    // 计算总时间：已完成的计次时间 + 当前运行时间
                    const completedLapsTime = adjustedLaps.reduce((sum, lap) => sum + lap.time, 0);
                    const currentLapTime = wasRunning ? (now - lastLapStartTime) : 0;
                    const totalTime = completedLapsTime + currentLapTime;
                    
                    // 如果之前在运行，自动继续运行
                    if (wasRunning) {
                        startTimeRef.current = now - totalTime;
                        lapStartTimeRef.current = lastLapStartTime;
                        
                        // 启动计时器，每10ms更新一次
                        intervalIdRef.current = setInterval(() => {
                            const currentTime = Date.now();
                            const elapsedTime = currentTime - startTimeRef.current;
                            setTime(elapsedTime);
                            currentTimeRef.current = elapsedTime;
                        }, 10);
                        
                        setIsRunning(true);
                    } else {
                        startTimeRef.current = now - totalTime;
                        lapStartTimeRef.current = now;
                        setIsRunning(false);
                    }
                    
                    setLaps(adjustedLaps);
                    setTime(totalTime);
                    currentTimeRef.current = totalTime;
                }
                
                // 检查通知权限
                if ('Notification' in window) {
                    setNotificationPermission(Notification.permission);
                    
                    // 如果尚未请求权限，自动请求
                    if (Notification.permission === 'default') {
                        Notification.requestPermission().then(permission => {
                            setNotificationPermission(permission);
                        });
                    }
                }
            }, []);
            
            // 自动保存效果：运行时每30秒保存一次状态
            useEffect(() => {
                if (isRunning) {
                    const autoSaveInterval = setInterval(() => {
                        const now = Date.now();
                        currentTimeRef.current = now - startTimeRef.current;
                        
                        localStorage.setItem('stopwatchState', JSON.stringify({
                            time: currentTimeRef.current,
                            laps,
                            isRunning,
                            startTime: startTimeRef.current,
                            lapStartTime: lapStartTimeRef.current
                        }));
                    }, 30000);

                    return () => clearInterval(autoSaveInterval);
                }
            }, [isRunning, laps]);

            // 保存状态到本地存储
            const saveState = useCallback(() => {
                const now = Date.now();
                const currentElapsedTime = isRunning ? now - startTimeRef.current : time;
                
                localStorage.setItem('stopwatchState', JSON.stringify({
                    time: currentElapsedTime,
                    laps,
                    isRunning,
                    startTime: startTimeRef.current,
                    lapStartTime: lapStartTimeRef.current
                }));
            }, [time, laps, isRunning]);

            // 开始计时
            const startStopwatch = () => {
                if (!isRunning) {
                    const now = Date.now();
                    if (time === 0) {
                        startTimeRef.current = now;
                    } else {
                        startTimeRef.current = now - time;
                    }
                    lapStartTimeRef.current = now;
                    
                    intervalIdRef.current = setInterval(() => {
                        const currentTime = Date.now();
                        const elapsedTime = currentTime - startTimeRef.current;
                        setTime(elapsedTime);
                        currentTimeRef.current = elapsedTime; // 更新当前时间引用
                    }, 10);
                    
                    setIsRunning(true);
                    saveState();
                }
            };

            // 停止计时
            const stopStopwatch = () => {
                if (isRunning) {
                    const now = Date.now();
                    clearInterval(intervalIdRef.current);
                    
                    // 保存当前 lap 的开始时间
                    const currentLapStartTime = lapStartTimeRef.current;
                    const lapTime = now - currentLapStartTime;
                    const totalTime = now - startTimeRef.current;
                    
                    if (lapTime > 0) {
                        setLaps(prevLaps => [
                            ...prevLaps,
                            {
                                startTime: currentLapStartTime,  // 使用保存的开始时间
                                endTime: now,
                                time: lapTime,
                                memo: '',
                                timestamp: new Date(now).toISOString()
                            }
                        ]);
                    }
                    
                    setIsRunning(false);
                    setTime(totalTime);
                    currentTimeRef.current = totalTime;
                    saveState();
                }
            };

            // 重置秒表
            const resetStopwatch = () => {
                if (window.confirm("Are you sure you want to reset the stopwatch?")) {
                    clearInterval(intervalIdRef.current);
                    setTime(0);
                    setLaps([]);
                    setIsRunning(false);
                    startTimeRef.current = 0;
                    lapStartTimeRef.current = 0;
                    saveState(); // 保存状态
                }
            };

            // 添加计次
            const addLap = () => {
                if (isRunning) {
                    const now = Date.now();
                    const lapTime = now - lapStartTimeRef.current;
                    
                    if (lapTime > 0) {
                        // 保存当前 lap 的开始时间
                        const currentLapStartTime = lapStartTimeRef.current;
                        
                        setLaps(prevLaps => [
                            ...prevLaps,
                            {
                                startTime: currentLapStartTime,  // 使用保存的开始时间
                                endTime: now,
                                time: lapTime,
                                memo: '',
                                timestamp: new Date(now).toISOString()
                            }
                        ]);
                        
                        lapStartTimeRef.current = now; // 为下一个 lap 设置新的开始时间
                        saveState();
                    }
                }
            };
            

            // 获取当前计次时间
            const getCurrentLapTime = () => {
                if (!isRunning && time === 0) return 0;
                const now = Date.now();
                return now - lapStartTimeRef.current;
            };


            // 更新计次备忘录
            const updateLapMemo = (index, memo) => {
                setLaps(prevLaps => prevLaps.map((lap, i) => 
                    i === index ? { ...lap, memo } : lap
                ));
                saveState(); // 保存状态
            };

            /* ---------------- 倒计时提醒逻辑 ---------------- */

            // 格式化倒计时显示（mm:ss）
            const formatCountdown = (ms) => {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000);
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            };

            // 启动倒计时
            const startCountdown = () => {
                if (!isCountdownRunning) {
                    startCountdownWithDuration(countdownDuration);
                }
            };
            
            // 发送系统通知
            const sendNotification = (title, options = {}) => {
                // 如果通知被禁用，不发送
                if (!notificationsEnabled) {
                    return;
                }
                
                // 检查浏览器是否支持通知
                if (!('Notification' in window)) {
                    console.log('This browser does not support notifications');
                    return;
                }
                
                // 如果已经有权限，直接发送通知
                if (Notification.permission === 'granted') {
                    try {
                        const notification = new Notification(title, {
                            icon: 'icon-192x192.png',
                            badge: 'icon-192x192.png',
                            vibrate: [200, 100, 200],
                            ...options
                        });
                        
                        // 点击通知时聚焦到当前窗口
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                    } catch (error) {
                        console.error('Error creating notification:', error);
                    }
                } 
                // 如果尚未请求权限或被拒绝，尝试请求
                else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        setNotificationPermission(permission);
                        
                        // 如果用户同意，发送通知
                        if (permission === 'granted') {
                            sendNotification(title, options);
                        }
                    });
                }
            };
            
            // 切换通知开关
            const toggleNotifications = () => {
                const newValue = !notificationsEnabled;
                setNotificationsEnabled(newValue);
                localStorage.setItem('notificationsEnabled', newValue);
            };
            
            // 使用指定时长启动倒计时（提取为独立函数以便复用）
            const startCountdownWithDuration = (duration) => {
                // 清除可能存在的旧定时器
                if (isCountdownRunning) {
                    clearInterval(countdownIntervalRef.current);
                }
                
                // 设置时长
                setCountdownDuration(duration);
                setCountdownRemaining(duration);
                
                // 启动倒计时
                countdownStartRef.current = Date.now();
                setIsCountdownRunning(true);

                countdownIntervalRef.current = setInterval(() => {
                    const elapsed = Date.now() - countdownStartRef.current;
                    let remaining = duration - elapsed;

                    if (remaining <= 0) {
                        // 触发提醒
                        setShowCountdownAlert(true);
                        
                        // 发送系统通知
                        const minutes = Math.floor(duration / 60000);
                        sendNotification(
                            '倒计时结束！', 
                            {
                                body: `${minutes}分钟倒计时已结束`,
                                tag: 'countdown-timer', // 使用tag标识通知类型
                                renotify: true // 即使有相同tag的通知也会再次提醒
                            }
                        );

                        // 无缝进入下一周期
                        countdownStartRef.current = Date.now();
                        remaining += duration;
                    }

                    setCountdownRemaining(remaining);
                }, 200);
            };

            // 停止倒计时
            const stopCountdown = () => {
                if (isCountdownRunning) {
                    clearInterval(countdownIntervalRef.current);
                    setIsCountdownRunning(false);
                }
            };

            // 修改倒计时时长
            const changeCountdownDuration = () => {
                const minutesStr = prompt("请输入倒计时时长（单位：分钟）", (countdownDuration / 60000).toString());
                const minutes = parseFloat(minutesStr);
                if (!isNaN(minutes) && minutes > 0) {
                    const newDuration = minutes * 60 * 1000;
                    setCountdownDuration(newDuration);
                    setCountdownRemaining(newDuration);

                    // 如果正在运行，重启倒计时
                    if (isCountdownRunning) {
                        clearInterval(countdownIntervalRef.current);
                        countdownStartRef.current = Date.now();
                        countdownIntervalRef.current = setInterval(() => {
                            const elapsed = Date.now() - countdownStartRef.current;
                            let remaining = newDuration - elapsed;
                            if (remaining <= 0) {
                                setShowCountdownAlert(true);
                                countdownStartRef.current = Date.now();
                                remaining += newDuration;
                            }
                            setCountdownRemaining(remaining);
                        }, 200);
                    }
                }
            };

            // 组件卸载时清理倒计时定时器
            useEffect(() => {
                return () => clearInterval(countdownIntervalRef.current);
            }, []);
            
            // OLED模式切换
            useEffect(() => {
                if (isOledMode) {
                    document.body.classList.add('oled-mode');
                    
                    // 启动元素微小位移动画
                    const elements = document.querySelectorAll('#root > *');
                    elements.forEach(el => {
                        el.style.animation = 'oledShift 10s ease-in-out infinite';
                        // 为每个元素设置略微不同的动画延迟，使移动不同步
                        el.style.animationDelay = `${Math.random() * 5}s`;
                    });
                } else {
                    document.body.classList.remove('oled-mode');
                    
                    // 停止元素微小位移动画
                    const elements = document.querySelectorAll('#root > *');
                    elements.forEach(el => {
                        el.style.animation = 'none';
                    });
                }
                
                // 保存OLED模式设置到本地存储
                localStorage.setItem('oledMode', isOledMode);
            }, [isOledMode]);

            // 格式化时间显示（用于UI显示）
            const formatTime = (ms) => {
                const getTwoDigits = (num) => String(Math.floor(num)).padStart(2, '0');
                const getThreeDigits = (num) => String(Math.floor(num)).padStart(3, '0');
                
                const hours = ms / (1000 * 60 * 60);
                const minutes = (ms % (1000 * 60 * 60)) / (1000 * 60);
                const seconds = (ms % (1000 * 60)) / 1000;
                const milliseconds = ms % 1000;
                
                return (
                    <span>
                        <span style={{ fontSize: '2.5rem' }}>
                            {getTwoDigits(hours)}:{getTwoDigits(minutes)}:{getTwoDigits(seconds)}
                        </span>
                        <span style={{ fontSize: '1rem', color: '#666' }}>
                            .{getThreeDigits(milliseconds)}
                        </span>
                    </span>
                );
            };


            // 格式化时间（用于CSV导出）
            const formatTimeForCSV = (ms) => {
                const getTwoDigits = (num) => String(Math.floor(num)).padStart(2, '0');
                const getThreeDigits = (num) => String(Math.floor(num)).padStart(3, '0');
                
                const hours = ms / (1000 * 60 * 60);
                const minutes = (ms % (1000 * 60 * 60)) / (1000 * 60);
                const seconds = (ms % (1000 * 60)) / 1000;
                const milliseconds = ms % 1000;
                
                return `${getTwoDigits(hours)}:${getTwoDigits(minutes)}:${getTwoDigits(seconds)}.${getThreeDigits(milliseconds)}`;
            };

            // 导出数据为CSV文件
            const exportDataAsCSV = () => {
                const BOM = '\uFEFF';
                
                const headers = "Lap Number,Lap Time,Start Time,End Time,Memo\n";
                const rows = laps.map((lap, index) => 
                    `${index + 1},${formatTimeForCSV(lap.time)},${new Date(lap.startTime).toLocaleString()},${new Date(lap.endTime).toLocaleString()},${lap.memo}`
                ).join('\n');
                const totalRow = `\nTotal Time,,${formatTimeForCSV(time)}`;
                
                const csvContent = BOM + headers + rows + totalRow;
                
                const blob = new Blob([csvContent], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                const link = document.createElement("a");
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", `stopwatch_data_${new Date().toISOString()}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            };

            // 渲染UI
            return (
                <div>
                    <h1 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '20px', textAlign: 'center' }}>
                        Stopwatch
                    </h1>
                            {/* 在这里添加下面的代码 */}
                    <div className="custom-message">
                        <textarea
                            className="custom-message-input"
                            value={customMessage}
                            onChange={(e) => {
                                setCustomMessage(e.target.value);
                                localStorage.setItem('customMessage', e.target.value);
                            }}
                            placeholder="在这里输入你的激励话语或待办事项..."
                        />
                    </div>
                    <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                        {formatTime(time)}
                    </div>
                    
                    <div style={{ textAlign: 'center', marginBottom: '20px' }}>
                        Current Lap: {formatTime(getCurrentLapTime())}
                    </div>
                    
                    <div className="button-group">
                        <button 
                            className="button button-primary"
                            onClick={startStopwatch} 
                            disabled={isRunning}
                        >
                            Start
                        </button>
                        
                        <button 
                            className="button button-danger"
                            onClick={stopStopwatch} 
                            disabled={!isRunning}
                        >
                            Stop
                        </button>
                        
                        <button 
                            className="button button-primary"
                            onClick={addLap} 
                            disabled={!isRunning}
                        >
                            Lap
                        </button>
                    </div>

                    <button 
                        className="button button-default"
                        onClick={resetStopwatch}
                        style={{ width: '100%', marginBottom: '10px' }}
                    >
                        Reset
                    </button>

                    {/* ---------------- 倒计时提醒 UI ---------------- */}
                    <div style={{ margin: '20px 0' }}>
                        <h2 style={{ textAlign: 'center' }}>倒计时提醒</h2>
                        <div style={{ textAlign: 'center', fontSize: '1.5rem', marginBottom: '20px' }}>
                            {formatCountdown(countdownRemaining)}
                        </div>
                        <div className="button-group">
                            <button
                                className="button button-primary"
                                onClick={startCountdown}
                                disabled={isCountdownRunning}
                            >
                                开始倒计时
                            </button>
                            <button
                                className="button button-danger"
                                onClick={stopCountdown}
                                disabled={!isCountdownRunning}
                            >
                                停止倒计时
                            </button>
                            <button
                                className="button button-default"
                                onClick={changeCountdownDuration}
                            >
                                自定义 ({Math.round(countdownDuration / 60000)} 分钟)
                            </button>
                        </div>
                        <div className="button-group" style={{ marginTop: '10px' }}>
                            <button
                                className="button button-default"
                                onClick={() => startCountdownWithDuration(1 * 60 * 1000)}
                            >
                                1分钟
                            </button>
                            <button
                                className="button button-default"
                                onClick={() => startCountdownWithDuration(3 * 60 * 1000)}
                            >
                                3分钟
                            </button>
                            <button
                                className="button button-default"
                                onClick={() => startCountdownWithDuration(5 * 60 * 1000)}
                            >
                                5分钟
                            </button>
                        </div>
                    </div>

                    {laps.length > 0 && (
                        <div className="lap-list">
                            <div className="lap-header">Laps</div>
                            {laps.slice().reverse().map((lap, index) => (
                                <div key={laps.length - index - 1} className="lap-item">
                                    <div>
                                        <div style={{ fontWeight: 'bold', marginBottom: '4px' }}>
                                            Lap {laps.length - index}
                                            <span style={{ 
                                                fontSize: '0.8rem', 
                                                color: '#666', 
                                                marginLeft: '8px',
                                                fontWeight: 'normal' 
                                            }}>
                                                ({lap.endTime === lap.startTime ? 'Lap' : 'Stop'})
                                            </span>
                                        </div>
                                        <div style={{ fontSize: '1.2rem' }}>
                                            {formatTimeForCSV(lap.time)}
                                        </div>
                                        <div style={{ 
                                            fontSize: '0.8rem', 
                                            color: '#666', 
                                            marginTop: '4px' 
                                        }}>
                                            Start: {new Date(lap.startTime).toLocaleString()}
                                            <br/>
                                            End: {new Date(lap.endTime).toLocaleString()}
                                        </div>
                                    </div>
                                    <div className="memo-box">
                                        <input
                                            className="input"
                                            value={lap.memo}
                                            onChange={(e) => updateLapMemo(laps.length - index - 1, e.target.value)}
                                            placeholder="Add memo"
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    <button 
                        className="button button-default"
                        onClick={exportDataAsCSV}
                        style={{ width: '100%', marginTop: '20px', marginBottom: '20px' }}
                    >
                        Export Data as CSV
                    </button>
                    
                    <button 
                        className="button button-primary"
                        onClick={() => setShowSettings(true)}
                        style={{ width: '100%' }}
                    >
                        设置
                    </button>
                    
                    {/* 设置面板 */}
                    <div className={`settings-panel ${showSettings ? 'active' : ''}`}>
                        <div className="settings-header">
                            <h2 style={{ margin: 0 }}>设置</h2>
                            <button className="settings-close" onClick={() => setShowSettings(false)}>×</button>
                        </div>
                        
                        <div className="settings-item">
                            <div>
                                <h3 style={{ margin: 0 }}>OLED模式</h3>
                                <p style={{ margin: '5px 0 0', color: '#666' }} className={isOledMode ? 'oled-mode' : ''}>
                                    黑色背景，降低耗电，避免烧屏
                                </p>
                            </div>
                            <label className="switch">
                                <input 
                                    type="checkbox" 
                                    checked={isOledMode} 
                                    onChange={() => {
                                        const newValue = !isOledMode;
                                        setIsOledMode(newValue);
                                        localStorage.setItem('oledMode', newValue);
                                    }}
                                />
                                <span className="slider"></span>
                            </label>
                        </div>
                        
                        <div className="settings-item">
                            <div>
                                <h3 style={{ margin: 0 }}>系统通知</h3>
                                <p style={{ margin: '5px 0 0', color: '#666' }} className={isOledMode ? 'oled-mode' : ''}>
                                    倒计时结束时发送系统通知
                                </p>
                            </div>
                            <label className="switch">
                                <input 
                                    type="checkbox" 
                                    checked={notificationsEnabled} 
                                    onChange={toggleNotifications}
                                    disabled={notificationPermission !== 'granted'}
                                />
                                <span className="slider"></span>
                            </label>
                        </div>
                        
                        {notificationPermission !== 'granted' && (
                            <button 
                                className="button button-primary"
                                onClick={() => {
                                    if ('Notification' in window) {
                                        Notification.requestPermission().then(permission => {
                                            setNotificationPermission(permission);
                                            if (permission === 'granted') {
                                                sendNotification('通知权限已获取', {
                                                    body: '倒计时结束时将发送系统通知',
                                                });
                                            } else {
                                                alert('需要通知权限才能在倒计时结束时发送系统通知');
                                            }
                                        });
                                    } else {
                                        alert('您的浏览器不支持系统通知');
                                    }
                                }}
                                style={{ width: '100%', marginTop: '20px' }}
                            >
                                {notificationPermission === 'denied' ? '通知权限已被拒绝，请在浏览器设置中允许' : '获取通知权限'}
                            </button>
                        )}
                    </div>

                    {/* 已将倒计时提醒UI移动到Reset按钮下方 */}

                    {/* 倒计时提醒覆盖层 */}
                    {showCountdownAlert && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            width: '100%',
                            height: '100%',
                            backgroundColor: 'rgba(255, 0, 0, 0.10)',
                            animation: 'countdownFlash 3s ease-in-out infinite',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 9999
                        }}>
                            <div style={{
                                backgroundColor: '#ffffff',
                                padding: '20px 40px',
                                borderRadius: '8px',
                                textAlign: 'center',
                                boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                            }}>
                                <p style={{ fontSize: '1.2rem', marginBottom: '20px', color: '#ff4d4f' }}>倒计时结束！</p>
                                <button
                                    className="button button-primary"
                                    onClick={() => setShowCountdownAlert(false)}
                                >
                                    确认
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 渲染React应用
        const { createRoot } = ReactDOM;
        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(Stopwatch));

        // PWA相关功能
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('ServiceWorker注册成功');
                    })
                    .catch(err => {
                        console.log('ServiceWorker注册失败: ', err);
                    });
            });
        }

        // PWA安装提示处理
        let deferredPrompt;
        const addBtn = document.createElement('button');
        addBtn.style.display = 'none';

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            addBtn.style.display = 'block';
            
            // 显示安装提示
            const installPrompt = document.getElementById('install-prompt');
            if (installPrompt) {
                installPrompt.style.display = 'block';
            }
        });
    </script>
</body>
</html>
